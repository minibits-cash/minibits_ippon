# Minibits Ippon

Ippon (一本, "one point", "decisive victory")

Minibits Ippon is a minimalistic, API-driven ecash and Lightning wallet implementing the Cashu protocol.

It is designed primarily for non-human systems — especially AI agents — that require instant, automated capability to receive and send micropayments without human intervention.

Minibits Ippon is intended for server-side deployment, ideally by a Cashu mint operator as a complementary service to their mint. It is therefore a fully custodial solution optimized for short-lived, single-purpose wallets with low balances.

To minimize complexity and provide an extremely simple API that AI agents can easily understand and use, Ippon adheres to strict design constraints:

### Single mint and single unit only
    
This simplifies the API and usage dramatically. Ippon is run by a mint operator who should not assume custody over ecash from other mints, keeping the operator's custody scope unchanged.

### Seed-less wallets
    
AI agents lack reliable long-term secret storage. Ippon wallets are expected to be short-lived, hold minimal balances, and should be emptied upon session completion. Seed-based wallets introduce unnecessary complexity and operational burden that neither agents nor wallet operators really need.

### No UI
    
The wallet exposes a very simple REST API with verbose, intuitive route and parameter names that hide ecash internals where possible. To make consuming the API by AI agents more natural, ippon_mcp project provides MCP server facade.

### Short-term security guarantees
    
Wallet access relies on a bare-bones access_key generated by the wallet server at creation time and later passed in the request’s Authorization header as a Bearer token. Given the short wallet lifetime and the expectation that a new wallet is created and funded for each longer session, there is no need for token refresh or revocation. To minimize necessity for AI agents to keep secrets, MCP server safeguards wallet access_key, linking it to agent's session_id.

### Arbitrary limits on wallets, balances and transactions
    
Due to the above constraints, the primary safeguard is a combination of rate limiting and of strict limits on maximum wallet balance and payment amounts. Limits are double-tiered:

-   Global limits set by the wallet operator on number of created wallets per ip address, max wallet balance and max ecash or lightning payment
    
-   Optional per-wallet balance and payment limits defined at wallet creation time. This prevents funding or outgoing payments from exceeding intended task scope.
    

## Wallet API

The API is versioned under `/v1/` and uses standard HTTP methods with JSON payloads.  
All authenticated endpoints require a `Bearer access_key` in the `Authorization` header (except wallet creation and public info).

### GET /v1/info

Returns machine-readable information about the wallet service, including status, supported unit, mint URL, and global limits.

| Authorization | Request Type | Response Type |
|---------------|--------------|---------------|
| N/A           | N/A          | WalletInfo    |

**Example:**
```bash
curl -X GET http://localhost:3000/v1/info
 ```

### POST /v1/wallet

Creates a new short-lived wallet. Optionally accepts an initial Cashu token to fund it immediately or a name for identification.

| Authorization | Request Type    | Response Type |
|---------------|-----------------|---------------|
| N/A           | WalletRequest   | Wallet        |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet \
  -H "Content-Type: application/json" \
  -d '{"name": "agent-007-session-001", "token": "cashuBeyJ..."}'
```

### GET /v1/wallet

Retrieves details of the current wallet, including its name, unit, mint, confirmed balance, and pending balance.

| Authorization          | Request Type | Response Type |
|------------------------|--------------|---------------|
| Bearer access_key      | N/A          | Wallet        |

**Example:**
```bash
curl -X GET http://localhost:3000/v1/wallet \
  -H "Authorization: Bearer abc123_access_key"
```

### POST /v1/wallet/deposit

Requests a Lightning invoice for funding the wallet with a specified amount. The wallet automatically handles the mint quote and ecash issuance once the invoice is paid.

| Authorization          | Request Type             | Response Type              |
|------------------------|--------------------------|----------------------------|
| Bearer access_key      | WalletDepositRequest     | WalletDepositResponse      |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/deposit \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"amount": 10000, "unit": "msat"}'
```

### GET /v1/wallet/deposit/:quote

Checks the status of a previously requested deposit quote (e.g., whether the invoice was paid and ecash minted).

| Authorization          | Request Type | Response Type              |
|------------------------|--------------|----------------------------|
| Bearer access_key      | N/A          | WalletDepositResponse      |

**Example:**
```bash
curl -X GET http://localhost:3000/v1/wallet/deposit/quote_abc123xyz \
  -H "Authorization: Bearer abc123_access_key"
 ```

### POST /v1/wallet/send

Generates and exports an ecash token for a specific amount (or pays a Cashu payment request if provided). The wallet handles any necessary swaps and marks proofs as pending to prevent double-spending.

| Authorization          | Request Type      | Response Type       |
|------------------------|-------------------|---------------------|
| Bearer access_key      | WalletSendRequest | WalletSendResponse  |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/send \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"amount": 5000, "unit": "msat", "memo": "Complete this task for me"}'
```

### POST /v1/wallet/check

Checks the current state of an exported Cashu token (e.g., whether it has been spent/swapped by the recipient).

| Authorization          | Request Type       | Response Type        |
|------------------------|--------------------|----------------------|
| Bearer access_key      | WalletCheckRequest | WalletCheckResponse  |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/check \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"token": "cashuB..."}'
```

### POST /v1/wallet/decode

Decodes a Cashu token, Cashu payment request, or Lightning invoice and returns structured information.

| Authorization          | Request Type        | Response Type         |
|------------------------|---------------------|-----------------------|
| Bearer access_key      | WalletDecodeRequest | WalletDecodeResponse  |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/decode \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"type": "CASHU_TOKEN_V4", "data": "cashuB..."}'
```

### POST /v1/wallet/pay

Pays an external Lightning invoice (or Lightning address) using the wallet's ecash balance. The wallet handles melt quote, fees, and returns any change.

| Authorization          | Request Type     | Response Type      |
|------------------------|------------------|--------------------|
| Bearer access_key      | WalletPayRequest | WalletPayResponse  |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/pay \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"bolt11_request": "lnbc50u...", "amount": 5000, "unit": "msat"}'
```

### GET /v1/wallet/pay/:quote

Checks the status of a melt quote / payment operation (e.g., whether the invoice was successfully paid).

| Authorization          | Request Type | Response Type      |
|------------------------|--------------|--------------------|
| Bearer access_key      | N/A          | WalletPayResponse  |

**Example:**
```bash
curl -X GET http://localhost:3000/v1/wallet/pay/etkpOx_SLLNEMOX2oEyk6y1ePKVp9sdUxc3k03bI \
  -H "Authorization: Bearer abc123_access_key"
```

### POST /v1/wallet/receive

Imports and processes an external Cashu token. The wallet validates token with the mint, and swaps it for a new ecash token.

| Authorization          | Request Type         | Response Type          |
|------------------------|----------------------|------------------------|
| Bearer access_key      | WalletReceiveRequest | WalletReceiveResponse  |

**Example:**
```bash
curl -X POST http://localhost:3000/v1/wallet/receive \
  -H "Authorization: Bearer abc123_access_key" \
  -H "Content-Type: application/json" \
  -d '{"token": "cashuB..."}'
```

### GET /v1/rate/:currency

Returns the current fiat exchange rate for the wallet's unit (e.g., satoshis per USD).

| Authorization          | Request Type | Response Type  |
|------------------------|--------------|----------------|
| Bearer access_key      | N/A          | RateResponse   |

**Example:**
```bash
curl -X GET http://localhost:3000/v1/rate/USD \
  -H "Authorization: Bearer abc123_access_key"
```

## Type Definitions

All types are in TypeScript notation for clarity. Despite wallet operates only with a single unit, amounts are always declared together with unit to keep the amount unambiguous (i.e., unit should always equal wallet's `MintUnit`).  

### Enums
```ts

  type MintUnit = "msat" | "sat";

  type MintMethod = "BOLT11";

  type WalletTokenState = "UNSPENT" | "PENDING" | "SPENT" | "MIXED" | "UNKNOWN";

  type EncodedType =

  | "BOLT11_REQUEST"

  | "CASHU_TOKEN_V4"

  | "CASHU_TOKEN_V3"

  | "CASHU_REQUEST";
```

### Core types

 ```ts

interface WalletInfo {

  status: string; // e.g., "operational"

  help: string; // Optional help text or link

  terms: string; // Terms of service or link

  unit: MintUnit; // Supported unit (single-unit wallet)

  mint: string; // Mint URL

  limits: {

    max_balance: number;

    max_send: number;

    max_pay: number;

  };
}


interface Wallet {

  name: string; // Optional wallet name/label

  access_key: string; // Bearer token for this wallet

  mint: string; // Mint URL

  unit: MintUnit;

  balance: number; // Confirmed / unspent balance

  pending_balance: number; // Pending (e.g., exported tokens not yet spent)

  limits?: { // Per-wallet overrides (optional)

    max_balance: number;

    max_send: number;

    max_pay: number;

  };
}

```

  

### Request / Response types

```ts

interface WalletRequest {

  name?: string; // Optional name for the wallet

  token?: string; // Optional initial Cashu token to deposit on creation

}

  

interface WalletDepositRequest {

  // Mirrors MintQuoteBolt11Request from cashu-ts

}

  

interface WalletDepositResponse {

  // Mirrors MintQuoteBolt11Response from cashu-ts

}

  

interface WalletSendRequest {

  amount: number;

  unit: MintUnit;

  cashu_request?: string; // Optional Cashu payment request to pay // NOT YET IMPLEMENTED

  memo?: string;

  lock_to_pubkey?: string; // Optional pubkey lock for P2PK // NOT YET IMPLEMENTED

}

  

interface WalletSendResponse {

  token: string; // Encoded Cashu token (v3 or v4)

  amount: number;

  unit: MintUnit;

  memo?: string;

}

  

interface WalletCheckRequest {

  token: string; // Encoded token to check

}

  

interface WalletCheckResponse {

  amount: number;

  unit: MintUnit;

  memo?: string;

  state: WalletTokenState;

  mint_proof_states: ProofState[]; // From cashu-ts (e.g., "UNSPENT", "SPENT")

}

  
  
  

interface WalletDecodeRequest {

  type: EncodedType;

  data: string; // Encoded string (token, invoice, request)

}

  

interface WalletDecodeResponse {

  type: EncodedType;

  decoded: any; // Decoded payload (structure varies by type)

}

  

interface WalletPayRequest {

  lightning_address?: string; // LNURL-pay / Lightning address

  bolt11_request?: string; // BOLT11 invoice

  amount: number;

  unit: MintUnit;

}

  

interface WalletPayResponse {

  // Mirrors MeltQuoteBolt11Response from cashu-ts

}

  

interface WalletReceiveRequest {

  token: string; // Encoded Cashu token to receive/swap

}

  

interface WalletReceiveResponse {

  amount: number;

  unit: MintUnit;

  balance: number; // New total confirmed balance

  pending_balance: number; // Updated pending

}

  

interface RateResponse {

  currency: string; // e.g., "USD", "EUR"

  rate: number; // sat / unit per fiat currency

  timestamp: number; // UNIX timestamp

}
  
```

## Development

Wallet is developed in Typescript and runs on Node.js using pm2 process manager. 
It uses Prisma ORM to communicate with the Postgres database and Fastify as a HTTP server.

## TO-DO's

[] lock token to pubkey
[] pay cashu payment request
[] add transactions model and API

